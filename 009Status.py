import os
import requests
from datetime import datetime
import time
import json

# Ù…Ù„Ù Ù„Ø­ÙØ¸ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ID
MESSAGE_FILE = 'message_data.json'

def get_fivem_status():
    """Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© FiveM Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"""
    try:
        # Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ Ù…Ù†Ø° Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„
        if not hasattr(get_fivem_status, "start_time"):
            get_fivem_status.start_time = time.time()
        
        elapsed_seconds = int(time.time() - get_fivem_status.start_time)
        
        status_data = {
            "Cfx Status": {
                "status": "â–ˆ", 
                "description": "Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ÙŠÙ Ø§Ù…"
            },
            "CnL": {
                "status": "â–ˆ", 
                "description": "Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"
            },
            "Policy": {
                "status": "â–ˆ", 
                "description": "Ø§ØªØµØ§Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø¨Ø³ÙŠØ±ÙØ±Ø§Øª ÙØ§ÙŠÙ Ø¥Ù…"
            },
            "Keymaster": {
                "status": "â–ˆ", 
                "description": "Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ÙŠØ³Ù† ÙƒÙŠ"
            },
            "Server List": {
                "status": "â–ˆ", 
                "description": "Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ù…ØªØµÙ„Ø©"
            },
            "License Status": {
                "status": "â–ˆ", 
                "description": "Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø®Øµ"
            },
            "Last Update": f"{elapsed_seconds} seconds ago",
            "Total Requests": "343823",
            "Current Time": datetime.now().strftime("Today at %I:%M %p")
        }
        return status_data
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£: {e}")
        return None

def create_discord_message(status_data):
    """Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ Ø¨Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙˆØ±Ø©"""
    if not status_data:
        return None
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©
    components = [
        {
            "type": 1,
            "components": [
                {
                    "type": 2,
                    "label": "Cfx Status",
                    "style": 3,  # Ø£Ø®Ø¶Ø±
                    "custom_id": "cfx_status",
                    "disabled": True  # ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¶ØºØ·
                },
                {
                    "type": 2,
                    "label": "License Status", 
                    "style": 3,  # Ø£Ø®Ø¶Ø±
                    "custom_id": "license_status",
                    "disabled": True  # ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¶ØºØ·
                },
                {
                    "type": 2,
                    "label": "Keymaster",
                    "style": 3,  # Ø£Ø®Ø¶Ø±
                    "custom_id": "keymaster",
                    "disabled": True  # ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¶ØºØ·
                }
            ]
        }
    ]
    
    embed = {
        "title": "ğŸ”¥ FiveM Status - Ø§Ù„Ù…Ù„ÙØ§Øª",
        "color": 0x00ff00,
        "fields": [
            {
                "name": "**Cfx Status:**",
                "value": f"Status â–ˆ\nDescription: Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ÙŠÙ Ø§Ù…",
                "inline": False
            },
            {
                "name": "**CnL:**", 
                "value": f"Status â–ˆ\nDescription: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", 
                "inline": False
            },
            {
                "name": "**Policy:**",
                "value": f"Status â–ˆ\nDescription: Ø§ØªØµØ§Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø¨Ø³ÙŠØ±ÙØ±Ø§Øª ÙØ§ÙŠÙ Ø¥Ù…",
                "inline": False
            },
            {
                "name": "**Keymaster:**", 
                "value": f"Status â–ˆ\nDescription: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ÙŠØ³Ù† ÙƒÙŠ",
                "inline": False
            },
            {
                "name": "**Server List:**",
                "value": f"Status â–ˆ\nDescription: Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ù…ØªØµÙ„Ø©", 
                "inline": False
            },
            {
                "name": "**License Status:**",
                "value": f"Status â–ˆ\nDescription: Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø®Øµ",
                "inline": False
            },
            {
                "name": "**Last Update:**",
                "value": status_data["Last Update"],
                "inline": False
            }
        ],
        "footer": {
            "text": f"Total Requests 343823 â€¢ {status_data['Current Time']}"
        }
    }
    
    return {
        "embeds": [embed],
        "components": components
    }

def load_message_data():
    """ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù…Ù„Ù"""
    try:
        with open(MESSAGE_FILE, 'r') as f:
            return json.load(f)
    except:
        return {"message_id": None, "webhook_url": None}

def save_message_data(message_id, webhook_url):
    """Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù…Ù„Ù"""
    try:
        data = {
            "message_id": message_id,
            "webhook_url": webhook_url
        }
        with open(MESSAGE_FILE, 'w') as f:
            json.dump(data, f)
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")

def send_or_edit_webhook(webhook_url, message_data, message_id=None):
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©"""
    try:
        if message_id:
            # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© - Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
            edit_url = f"{webhook_url}/messages/{message_id}"
            response = requests.patch(edit_url, json=message_data, timeout=10)
            
            if response.status_code == 404:
                print("ğŸ“ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©")
                return None
        else:
            # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            response = requests.post(webhook_url, json=message_data, timeout=10)
        
        if response.status_code in [200, 204]:
            if message_id:
                print("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!")
            else:
                print("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!")
            
            if not message_id and response.status_code == 200:
                response_data = response.json()
                return response_data.get('id')
            return message_id
        else:
            print(f"âŒ ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {response.status_code} - {response.text}")
            return None
            
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {e}")
        return None

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    webhook_url = os.environ.get('WEBHOOK_URL')
    
    if not webhook_url:
        print("âŒ Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† WEBHOOK_URL")
        return
    
    print("ğŸš€ Ø¨Ø¯Ø£ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© FiveM...")
    
    # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    message_data = load_message_data()
    last_message_id = message_data.get("message_id")
    last_webhook_url = message_data.get("webhook_url")
    
    # Ø¥Ø°Ø§ ØªØºÙŠØ± Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒØŒ Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯
    if last_webhook_url != webhook_url:
        print("ğŸ”„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ ØªØºÙŠØ±ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©")
        last_message_id = None
    
    print(f"ğŸ“ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ID: {last_message_id}")
    
    # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    status_data = get_fivem_status()
    
    if status_data:
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        message = create_discord_message(status_data)
        
        if message:
            # Ø¥Ø±Ø³Ø§Ù„ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            new_message_id = send_or_edit_webhook(webhook_url, message, last_message_id)
            
            if new_message_id:
                # Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                save_message_data(new_message_id, webhook_url)
                print(f"ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ID: {new_message_id}")
                print(f"ğŸ• Ø§Ù„ÙˆÙ‚Øª: {status_data['Last Update']}")
            else:
                # Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø£Ù†Ø´Ø¦ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                print("ğŸ”„ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©...")
                new_message_id = send_or_edit_webhook(webhook_url, message, None)
                if new_message_id:
                    save_message_data(new_message_id, webhook_url)
                    print(f"ğŸ’¾ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ID: {new_message_id}")
                else:
                    print("ğŸ’¥ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©")
                    save_message_data(None, webhook_url)
        else:
            print("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©")
    else:
        print("âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©")

if __name__ == "__main__":
    main()
